module purge
host=`hostname`

if [[ $host == *"twcc.ai" ]]; then

  echo "==== on TWCC"
  module load miniconda3
  conda activate /opt/ohpc/pkg/kagra/ENV/py37
  module load nvhpc/21.7
  
  export CXX=nvc++
  export OPT="-acc=gpu -O3 -Minfo=acc -ta=tesla:managed"


elif [[ $host == "node1" ]]; then
  
  echo "==== on N1 A100"
  module load nvhpc/22.2

  export CUDA_VISIBLE_DEVICES=0
  unset CFLAGS
  #export CFLAGS=-DNVTX
  #export LIBS="-L/usr/local/cuda/lib64 -lnvToolsExt -lcufft"
  #export LIBS="-L/usr/local/cuda/lib64 -lcufft"

  export CXX=nvc++
  export OPT="-mp -O4 -Minfo=mp  -DIM_SIMPSON"
  export OPT="-O4 -acc=gpu -Minfo=acc -gpu=managed"

else
  echo "==== on ARM"
  module load python/3.8.5
  module load acfl/22.0.1 armpl/22.0.1
  #module load gcc9/papi/6.0
  #export PAPI_MULTIPLEX=1

  export CXX=armclang++
  export OPT="-Ofast -std=c++11 -fopenmp -DIM_SIMPSON -fsave-optimization-record"
  export OPT="-Ofast -std=c++11 -fopenmp -armpl -DIM_SIMPSON"
  ## -DADVEC_OFF"
fi

make
